[README.md](README.md)

### Компоненты

#### 1. LLM-классификатор (входной уровень)

Первый компонент pipeline, выполняющий две критические функции:

- **Фильтрация запросов**: определяет релевантность сообщения пользователя заданной тематике и выдаёт РАЗРЕШЕНО или ЗАПРЕЩЕНО
- **Переформулировка запроса**: переформулирует пользовательский ввод для улучшения понимания намерений

Если запрос нерелевантен, система завершает обработку на этом этапе, pipeline не запускается, и выдаётся заготовленный ответ. Релевантные запросы передаются дальше в переформулированном виде.

#### 2. Агент-оркестровщик (центральный узел)

Главный координирующий агент с доступом к специализированным инструментам. Функции оркестровщика:

- Определение последовательности вызова инструментов
- Координация работы агентов-инструментов
- Формирование финального ответа пользователю

#### 3. Инструменты-агенты

##### 3.1. Агент актуальных курсов

Использует MCP-сервер для получения текущего курса валютной пары.

**Инструменты**: 
- `get_latest_rate(base_currency: str, target_currency: str)`
- Вызов файла для проверки ISO кодов валют.

##### 3.2. Агент исторических курсов

Использует другой MCP-сервер для получения курса на заданную дату.

**Инструменты**: 
- `get_historical_rate(year: int, month: int, day: int, base_currency: str, target_currency: str, amount: float (optional))`
- Вызов файла для проверки ISO кодов валют.

##### 3.3. Агент-калькулятор

Обёртка над MCP-сервером калькулятора для выполнения математических операций. Используется для расчёта конвертации валют, разницы курсов и трендов.

**Инструмент**: встроенный калькулятор из langflow

##### 3.4. Инструмент ISO-кодов

Предоставляет справочную информацию о доступных ISO-кодах валют для валидации пользовательского ввода.

#### 4. Агент-валидатор 

Финальный компонент pipeline, проверяющий корректность выполнения запроса. Оркестровщик вызывает валидатор перед отправкой ответа пользователю. Валидатор анализирует, полностью ли выполнена задача и соответствует ли результат ожиданиям. 
Если задача не выполнена, то даёт запрос оркестровщику выполнить этапы заново и перепроверить.

#### 5. Форматирование ответа

Маленькие модели часто галлюцинировали и выдавали какие-то лишние сообщения рассуждения перед ответов, поэтому в инструкции сказано начинать ответ для пользователя с фразы "Ответ:". Благодаря этому можно удалять весь текст до фразы "Ответ:", включая саму эту фразу, и ответ получается более чистым.

## Поток данных

1. **Вход**: пользователь отправляет запрос на естественном языке
2. **Классификация**: LLM определяет релевантность и переформулирует запрос
3. **Оркестрация**: центральный агент анализирует задачу и вызывает нужные инструменты в правильной последовательности
4. **Выполнение**: агенты-инструменты обращаются к MCP-серверам и возвращают данные
5. **Валидация**: агент-валидатор проверяет полноту выполнения запроса
6. **Постобработка**: удаление промежуточных рассуждений из ответа
7. **Выход**: пользователь получает финальный ответ